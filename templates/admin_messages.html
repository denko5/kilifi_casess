{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">Admin Message Center</h2>

  <!-- Summary Cards -->
  <div class="row g-3 text-center">
    <div class="col-md-4">
      <div class="card bg-primary text-white shadow-sm">
        <div class="card-body">
          <h5>Total Messages</h5>
          <h3>{{ messages|length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white shadow-sm">
        <div class="card-body">
          <h5>Replied</h5>
          <h3>{{ messages | selectattr('reply') | list | length }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-warning text-dark shadow-sm">
        <div class="card-body">
          <h5>Pending</h5>
          <h3>{{ messages | rejectattr('reply') | list | length }}</h3>
        </div>
      </div>
    </div>
  </div>
<form method="POST" action="{{ url_for('delete_messages') }}">
<div class="mt-5">
  <h4 class="mb-3 text-danger">Manage Messages</h4>
  <form method="POST" action="{{ url_for('delete_messages') }}">
    <button type="submit" class="btn btn-sm btn-danger mb-3">Delete Selected</button>
    {% for msg in messages %}
      <div class="card mb-3 shadow-sm {% if msg.reply %}border-success{% else %}border-warning{% endif %}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h6><strong>From:</strong> {{ msg.user.full_name }}</h6>
            <input type="checkbox" name="delete_ids" value="{{ msg.id }}">
          </div>
          <p><strong>Message:</strong> {{ msg.message }}</p>
          <p><small>Submitted at {{ msg.submitted_at.strftime('%Y-%m-%d %H:%M') }}</small></p>

          {% if msg.reply %}
            <hr>
            <p><strong>Reply:</strong> {{ msg.reply }}</p>
            <p><small>Replied at {{ msg.replied_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
          {% else %}
            <!-- Inline Reply Form OUTSIDE the delete form -->
            <form method="POST" action="{{ url_for('reply_message', msg_id=msg.id) }}">
              <div class="mb-2">
                <textarea name="reply" class="form-control" rows="3" placeholder="Type your reply here..." required></textarea>
              </div>
              <button type="submit" class="btn btn-sm btn-primary">Send Reply</button>
            </form>
          {% endif %}

          <!-- Single Delete Button -->
          <form method="POST" action="{{ url_for('delete_single_message', msg_id=msg.id) }}" class="mt-2">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete This Message</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </form>
</div>


{% endblock %}
